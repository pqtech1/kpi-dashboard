<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Jewel INTEGRA</title>

    <meta
      name="description"
      content="Jewel INTEGRA is an ERP-agnostic integration platform and plant KPI dashboard for jewellery manufacturing, enabling real-time insights, automation, and system connectivity."
    />

    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <meta name="author" content="Jewel INTEGRA" />

    <!-- Open Graph -->
    <meta property="og:title" content="Jewel INTEGRA" />
    <meta
      property="og:description"
      content="ERP-agnostic integration platform with real-time plant KPI dashboards for jewellery manufacturing."
    />
    <meta property="og:type" content="website" />
    <!-- Replace with your own image -->
    <meta property="og:image" content="/og-image.png" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Jewel INTEGRA" />
    <meta
      name="twitter:description"
      content="ERP-agnostic integration & real-time KPI dashboards for jewellery plants."
    />
    <meta name="twitter:image" content="/og-image.png" />
  </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>

    <!-- Email Campaign Tracking Script -->
    <script>
      (function () {
        // Get tracking data from URL parameters
        function getTrackingData() {
          const params = new URLSearchParams(window.location.search);
          const trackingData = {
            campaign_id:
              params.get("campaign_id") || getCookie("tracking_campaign_id"),
            lead_id: params.get("lead_id") || getCookie("tracking_lead_id"),
            email: params.get("email") || getCookie("tracking_email"),
            source: params.get("source") || "direct",
          };

          // Return null if any required field is missing
          if (
            !trackingData.campaign_id ||
            !trackingData.lead_id ||
            !trackingData.email
          ) {
            return null;
          }

          return trackingData;
        }

        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(";").shift();
          return null;
        }

        // Set tracking cookies if we have URL parameters
        function setTrackingCookies() {
          const params = new URLSearchParams(window.location.search);
          const campaignId = params.get("campaign_id");
          const leadId = params.get("lead_id");
          const email = params.get("email");
          const source = params.get("source");

          if (campaignId && leadId && email) {
            // Set cookies that expire in 7 days
            const expires = new Date(
              Date.now() + 7 * 24 * 60 * 60 * 1000
            ).toUTCString();
            document.cookie = `tracking_campaign_id=${campaignId}; expires=${expires}; path=/; SameSite=Lax`;
            document.cookie = `tracking_lead_id=${leadId}; expires=${expires}; path=/; SameSite=Lax`;
            document.cookie = `tracking_email=${encodeURIComponent(
              email
            )}; expires=${expires}; path=/; SameSite=Lax`;
            if (source) {
              document.cookie = `tracking_source=${source}; expires=${expires}; path=/; SameSite=Lax`;
            }
          }
        }

        // Track page view
        function trackPageView() {
          const data = getTrackingData();
          if (!data) {
            console.log("No tracking data available");
            return;
          }

          const pageData = {
            campaign_id: data.campaign_id,
            lead_id: data.lead_id,
            email: data.email,
            page_url: window.location.href,
            page_title: document.title,
            referrer: document.referrer,
            time_spent: 0,
            scroll_depth: 0,
            session_id:
              sessionStorage.getItem("tracking_session_id") ||
              generateSessionId(),
          };

          // Store session ID for this session
          if (!sessionStorage.getItem("tracking_session_id")) {
            sessionStorage.setItem("tracking_session_id", pageData.session_id);
          }

          // Send initial page view
          sendTracking("page-view", pageData);

          // Track time on page
          let startTime = Date.now();
          let maxScroll = 0;
          let scrollInterval;

          // Track scroll depth continuously
          window.addEventListener("scroll", () => {
            const scrollPercent = Math.round(
              (window.scrollY /
                (document.documentElement.scrollHeight - window.innerHeight)) *
                100
            );
            maxScroll = Math.max(maxScroll, scrollPercent);
          });

          // Send final data before page unload
          window.addEventListener("beforeunload", () => {
            pageData.time_spent = Math.floor((Date.now() - startTime) / 1000);
            pageData.scroll_depth = maxScroll;
            sendTracking("page-view", pageData, true); // Use sendBeacon for unload
          });
        }

        // Track link clicks
        function trackLinkClicks() {
          document.addEventListener("click", function (e) {
            const link = e.target.closest("a");
            if (!link) return;

            const data = getTrackingData();
            if (!data) return;

            // Skip if href is empty or starts with javascript:
            if (!link.href || link.href.startsWith("javascript:")) return;

            const clickData = {
              campaign_id: data.campaign_id,
              lead_id: data.lead_id,
              email: data.email,
              link_url: link.href,
              link_text: link.textContent?.trim().substring(0, 500) || "",
              page_url: window.location.href,
              element_id: link.id || "",
              element_class: link.className || "",
              link_type: determineLinkType(link),
            };

            // Send tracking data using sendBeacon for reliability
            sendTracking("internal-click", clickData, true);
          });
        }

        // Determine link type based on URL patterns
        function determineLinkType(link) {
          const href = link.href.toLowerCase();
          const text = link.textContent?.toLowerCase() || "";

          if (href.includes("/production") || text.includes("production"))
            return "production";
          if (
            href.includes("/material-cost") ||
            text.includes("material") ||
            text.includes("cost")
          )
            return "material_cost";
          if (
            href.includes("/design-cad") ||
            text.includes("design") ||
            text.includes("cad")
          )
            return "design";
          if (href.includes("/casting")) return "casting";
          if (href.includes("/finishing")) return "finishing";
          if (href.includes("/quality-control") || text.includes("quality"))
            return "quality";
          if (href.includes("/executive")) return "executive";
          if (
            href.includes("/pq-offering") ||
            text.includes("expertise") ||
            text.includes("services")
          )
            return "services";
          if (href.includes("positivequadrant.in"))
            return "external_positivequadrant";
          if (href.includes("techupgrad.in")) return "internal_techupgrad";

          // Check for common patterns
          if (href.includes("contact") || href.includes("mailto:"))
            return "contact";
          if (href.includes("download") || href.includes(".pdf"))
            return "download";

          return "other";
        }

        // Generate unique session ID
        function generateSessionId() {
          return (
            "session_" +
            Date.now() +
            "_" +
            Math.random().toString(36).substr(2, 9)
          );
        }

        // Send tracking data to your server
        function sendTracking(type, data, useBeacon = false) {
          const endpoints = {
            "page-view": "/track-page-view",
            "internal-click": "/track-internal-click",
          };

          if (!endpoints[type]) return;

          const url = endpoints[type];

          if (useBeacon && navigator.sendBeacon) {
            // Use Beacon API for reliable sending during page unload
            const formData = new FormData();
            Object.keys(data).forEach((key) => {
              formData.append(key, data[key]);
            });
            navigator.sendBeacon(url, formData);
          } else {
            // Use fetch for other tracking
            fetch(url, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
                "X-Requested-With": "XMLHttpRequest",
              },
              body: JSON.stringify(data),
              keepalive: true, // Keep request alive even after page unload
            }).catch((error) => {
              console.error("Tracking error:", error);
            });
          }
        }

        // Initialize tracking when DOM is ready
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", initTracking);
        } else {
          initTracking();
        }

        function initTracking() {
          // Set tracking cookies from URL parameters
          setTrackingCookies();

          // Initialize tracking
          trackPageView();
          trackLinkClicks();

          console.log("Email campaign tracking initialized");
        }
      })();
    </script>
  </body>
</html>
